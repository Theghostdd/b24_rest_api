<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <style>
      * {
          box-sizing: border-box;
      }
      body {
          font-family: 'Roboto', sans-serif;
          background-color: #0a0a0a;

      }
      #status {
          font-family: Arial, sans-serif;
          margin-top: 20px;
          border: 1px solid #2d2d2e;
          border-radius: 5px;
          background-color: #19191a;
          padding: 1em;
          color: #529ef3;
      }
      #process {
          font-family: Arial, sans-serif;
          margin-top: 20px;
          border: 1px solid #2d2d2e;
          border-radius: 5px;
          background-color: #19191a;
          padding: 1em;
          color: #e5e5e5;
      }

      #status {
          text-transform: uppercase;
          font-size: 20px;
      }

      #processing {
          display: inline-flex;
          align-items: center;
      }

      .dot {
          font-size: 24px;
          color: #529ef3;
          opacity: 0;
          animation: blink 1.5s infinite;
      }

      @keyframes blink {
          0% {
              opacity: 0;
          }
          50% {
              opacity: 1;
          }
          100% {
              opacity: 0;
          }
      }

      .dot:nth-child(1) {
          animation-delay: 0s;
      }

      .dot:nth-child(2) {
          animation-delay: 0.5s;
      }

      .dot:nth-child(3) {
          animation-delay: 1s;
      }

      .info {
          padding-bottom: 10px;
          padding-top: 10px;
          border-bottom: 1px solid #2d2d2e;
      }

      .error {
          color: #ff0000;
      }
      .success {
          color: #05d705;
      }
  </style>
</head>
<body>
<div id="process"></div>

<div id="status">
    <span id="status-text">Processing</span>
    <span id="processing">
      <span class="dot">.</span>
      <span class="dot">..</span>
      <span class="dot">...</span>
    </span>
</div>

<script src="//api.bitrix24.com/api/v1/"></script>
<script type="text/javascript">
  const delay = (ms) => {
    return new Promise((res) => {
      setTimeout(() => {
        res()
      }, ms)
    })
  }

  const updateStatus = async (message, ms) => {
    document.getElementById('status-text').innerText = message;
    await delay(ms)
  }
  const updateProcess = async (message, ms, className) => {
    const process = document.getElementById('process');
    const messageBox = document.createElement('div')
    messageBox.classList.add('info', className)

    if (typeof message !== 'string') {
      try {
        const formattedMessage = JSON.stringify(message, null, 2);
        const preElement = document.createElement('pre');
        preElement.textContent = formattedMessage;
        messageBox.appendChild(preElement);
      } catch (e) {
        messageBox.append(message)
      }
    } else {
      messageBox.append(message)
    }
    process.append(messageBox)
    await delay(ms)
  }
  updateStatus("Loading", 0)
  updateProcess("Loading", 0)

  BX24.fitWindow(data => {
    let x = BX24.getScrollSize();
    BX24.resizeWindow(x.scrollWidth, 1000)
  })


  BX24.init(async function() {
    await updateStatus("Installation", 500)
    await updateProcess("Setting the application parameter", 500)
    const params = {
      'CODE': 'ntr_rest', // the symbolic code of the action
      'HANDLER': 'https://your-handler.com/', // action handler
      'AUTH_USER_ID': 1, // The ID of the user whose token will be transferred to the application.
      'USE_SUBSCRIPTION': '', // Using a subscription. Acceptable values are Y or N.
                              // You can specify whether to expect a response action from the application.
                              // If the parameter is empty or not specified, the user can configure this parameter himself in the action settings in the business process designer.
      'NAME': {
        'ru': 'REST API', // the name of the action in the BP editor
      },
      'DESCRIPTION': {
        'ru': 'REST API', // description of the action in the BP editor
      },
      'PROPERTIES': { // Array of input parameters
        'method': {
          'NAME': {
            'ru': 'Method',
          },
          'Description': {
            'ru': 'The bitrix24 api method',
          },
          'Type': 'string',
          'Required': 'Y',
          'Multiple': 'N',
          'Default': '',
        },

        'body': {
          'NAME': {
            'ru': 'JSON',
          },
          'Description': {
            'ru': 'JSON body',
          },
          'Type': 'text',
          'Required': 'Y',
          'Multiple': 'N',
          'Default': '',
        },
        'keys': {
          'NAME': {
            'ru': 'JSONPath',
          },
          'Description': {
            'ru': 'JSONPath',
          },
          'Type': 'string',
          'Required': 'Y',
          'Multiple': 'Y',
          'Default': '$',
        },
        'isBig': {
          'NAME': {
            'ru': 'Getting more than 50 entries?',
          },
          'Description': {
            'ru': 'Getting more than 50 records',
          },
          'Type': 'bool',
          'Required': 'Y',
          'Multiple': 'N',
          'Default': 'N',
        },

      },
      'RETURN_PROPERTIES': { // array of output parameters
        'result': {
          'Name': {
            'ru': 'Result',
          },
          'Type': 'string',
          'Multiple': 'Y',
          'Default': null,
        },

        'result_1': {
          'Name': {
            'ru': 'Result 1',
          },
          'Type': 'string',
          'Multiple': 'Y',
          'Default': null,
        },
        'result_2': {
          'Name': {
            'ru': 'Result 2',
          },
          'Type': 'string',
          'Multiple': 'Y',
          'Default': null,
        },

        'result_3': {
          'Name': {
            'ru': 'Result 3',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_4': {
          'Name': {
            'ru': 'Result 4',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_5': {
          'Name': {
            'ru': 'Result 5',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_6': {
          'Name': {
            'ru': 'Result 6',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_7': {
          'Name': {
            'ru': 'Result 7',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_8': {
          'Name': {
            'ru': 'Result 8',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_9': {
          'Name': {
            'ru': 'Result 9',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_10': {
          'Name': {
            'ru': 'Result 10',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

      },
    };
    await updateProcess(params, 500)
    await updateProcess("Setting the application parameter for number to word", 500)
    const params2 = {
      'CODE': 'number_to_word',
      'HANDLER': 'https://your-handler.com/',
      'AUTH_USER_ID': 1,
      'USE_SUBSCRIPTION': '',
      'NAME': {
        'ru': 'Number to word',
      },
      'DESCRIPTION': {
        'ru': 'Number to word',
      },
      'PROPERTIES': {
        'number': {
          'NAME': {
            'ru': 'Number',
          },
          'Description': {
            'ru': 'Getting the decryption',
          },
          'Type': 'string',
          'Required': 'Y',
          'Multiple': 'N',
          'Default': '',
        },
      },
      'RETURN_PROPERTIES': {
        'result': {
          'Name': {
            'ru': 'Result',
          },
          'Type': 'string',
          'Multiple': 'Y',
          'Default': null,
        },

        'result_1': {
          'Name': {
            'ru': 'Result 1',
          },
          'Type': 'string',
          'Multiple': 'Y',
          'Default': null,
        },
        'result_2': {
          'Name': {
            'ru': 'Result 2',
          },
          'Type': 'string',
          'Multiple': 'Y',
          'Default': null,
        },

        'result_3': {
          'Name': {
            'ru': 'Result 3',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_4': {
          'Name': {
            'ru': 'Result 4',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_5': {
          'Name': {
            'ru': 'Result 5',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_6': {
          'Name': {
            'ru': 'Result 6',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_7': {
          'Name': {
            'ru': 'Result 7',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_8': {
          'Name': {
            'ru': 'Result 8',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_9': {
          'Name': {
            'ru': 'Result 9',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },

        'result_10': {
          'Name': {
            'ru': 'Result 10',
          },
          'Type': 'string',
          'Multiple': 'N',
          'Default': null,
        },
      },
    };
    await updateProcess(params2, 500)
    await updateProcess('Updating the application', 500)
    await updateStatus("Updating", 500)

    BX24.callMethod(
      'bizproc.activity.update',
      params,
      function(result) {
        if (result.error()) {
          document.getElementById('status-text').classList.add('error')
          updateStatus('Something went wrong.');
          document.getElementById('processing').remove()
          console.log(typeof result.error())
          updateProcess(result.error(), 0 , 'error')
        } else {
          document.getElementById('status-text').classList.add('success')
          updateStatus('The action has been successfully updated');
          updateProcess('Successfully updated', 0 , 'success')
          document.getElementById('processing').remove()
          BX24.installFinish();
        }
      }
    );

    await updateStatus("Installation - number - to word", 500)

    BX24.callMethod(
      'bizproc.activity.update',
      params2,
      function(result) {
        if (result.error()) {
          document.getElementById('status-text').classList.add('error')
          updateStatus('Something went wrong.');
          document.getElementById('processing').remove()
          console.log(typeof result.error())
          updateProcess(result.error(), 0 , 'error')
        } else {
          document.getElementById('status-text').classList.add('success')
          updateStatus('The action has been successfully updated');
          updateProcess('Successfully updated', 0 , 'success')
          document.getElementById('processing').remove()
          BX24.installFinish();
        }
      }
    );
  });
</script>

</body>
</html>
